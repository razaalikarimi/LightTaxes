# ğŸ›ï¸ LightTaxes Architecture - Visual Guide

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        USER INPUT (input.json)                          â”‚
â”‚                  From TaxCalcBench or Custom Input                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     TAX RETURN PROCESSOR                                â”‚
â”‚                   (Main Orchestrator - main.py)                         â”‚
â”‚                                                                          â”‚
â”‚  - Parses input.json                                                    â”‚
â”‚  - Manages form dependencies                                            â”‚
â”‚  - Routes data between agents                                           â”‚
â”‚  - Coordinates verification                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                                 â”‚
                â–¼                                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   FORM DEPENDENCY    â”‚       â”‚   SUPPORT SYSTEMS    â”‚
    â”‚       GRAPH          â”‚       â”‚                      â”‚
    â”‚                      â”‚       â”‚  â€¢ LLM Engine        â”‚
    â”‚  Schedule B          â”‚       â”‚  â€¢ PDF Navigator     â”‚
    â”‚       â”‚              â”‚       â”‚  â€¢ Type System       â”‚
    â”‚       â–¼              â”‚       â”‚  â€¢ Citation Tracker  â”‚
    â”‚  Schedule C          â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚       â”‚              â”‚
    â”‚       â–¼              â”‚
    â”‚  Schedule SE         â”‚
    â”‚       â”‚              â”‚
    â”‚       â–¼              â”‚
    â”‚  Schedule 1          â”‚
    â”‚       â”‚              â”‚
    â”‚       â–¼              â”‚
    â”‚   Form 1040          â”‚
    â”‚       â”‚              â”‚
    â”‚       â–¼              â”‚
    â”‚  Schedule 8812       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        FORM OUTPUTS                                      â”‚
â”‚                     (Form 1040 Complete)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       VERIFIER SWARM                                     â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  Arithmetic  â”‚  â”‚  Logic       â”‚  â”‚  Cross-Form  â”‚                 â”‚
â”‚  â”‚  Verifier    â”‚  â”‚  Verifier    â”‚  â”‚  Verifier    â”‚                 â”‚
â”‚  â”‚  âœ“ Working   â”‚  â”‚  (Planned)   â”‚  â”‚  (Planned)   â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚         â”‚                                                                â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                           â–¼                                              â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚                  â”‚  Judge Agent    â”‚                                    â”‚
â”‚                  â”‚   (Planned)     â”‚                                    â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FINAL OUTPUT (output.xml)                            â”‚
â”‚                  Verified Form 1040 Tax Return                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Form Agent Detail

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     FORM AGENT (Base Class)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  Input: Typed FormInputs (Pydantic)                         â”‚
â”‚    â”‚                                                          â”‚
â”‚    â”œâ”€â–º PDF Navigator â”€â”€â”€â”€â–º IRS Instructions                 â”‚
â”‚    â”‚                                                          â”‚
â”‚    â”œâ”€â–º LLM Engine â”€â”€â”€â”€â”€â”€â”€â”€â–º Line-by-line Reasoning          â”‚
â”‚    â”‚                                                          â”‚
â”‚    â”œâ”€â–º Deterministic Tools â–º Exact Calculations             â”‚
â”‚    â”‚                                                          â”‚
â”‚    â””â”€â–º Citation Tracker â”€â”€â–º Audit Trail                     â”‚
â”‚                                                               â”‚
â”‚  Output: Typed FormOutputs (Pydantic) + Citations           â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Example: Form 1040 Agent Flow

```
Input:
  â””â”€ Wages: $50,000
  â””â”€ Withholding: $5,000
  â””â”€ Filing Status: Single

          â”‚
          â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Line 1z â”‚  Wages from W-2
     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
          â”‚  Citation: "Form W-2, Box 1"
          â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Line 9  â”‚  Total Income = Line 1z
     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
          â”‚
          â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Line 10 â”‚  Adjustments = 0
     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
          â”‚
          â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Line 11 â”‚  AGI = Line 9 - Line 10 = $50,000
     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
          â”‚  Citation: "Form 1040 Instructions, Line 11"
          â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Line 12 â”‚  Standard Deduction (Single) = $14,600
     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     [DETERMINISTIC TOOL - No LLM]
          â”‚  Citation: "IRS Standard Deduction 2024"
          â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Line 15 â”‚  Taxable Income = $50,000 - $14,600 = $35,400
     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
          â”‚
          â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Line 16 â”‚  Tax = $4,016
     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     [DETERMINISTIC TOOL - Tax Table]
          â”‚  Citation: "2024 Tax Computation Worksheet"
          â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Line 24 â”‚  Total Tax = $4,016
     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
          â”‚
          â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Line 33 â”‚  Payments = $5,000
     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
          â”‚
          â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Line 34 â”‚  REFUND = $5,000 - $4,016 = $984
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Output:
  â””â”€ Form 1040 with all lines calculated
  â””â”€ Citations for each decision
  â””â”€ Warnings/Errors if any
```

---

## Component Architecture

### 1. LLM Engine

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          LLM ENGINE                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                        â”‚
â”‚  Unified Interface:                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚  OpenAI    â”‚ â”€â”€â–º GPT-4             â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚
â”‚  â”‚ Anthropic  â”‚ â”€â”€â–º Claude 3.5        â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚
â”‚  â”‚  Google    â”‚ â”€â”€â–º Gemini 1.5        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                        â”‚
â”‚  Methods:                             â”‚
â”‚  â€¢ generate(prompt, system)           â”‚
â”‚  â€¢ generate_structured(prompt)        â”‚
â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. PDF Navigator

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         PDF NAVIGATOR                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                        â”‚
â”‚  IRS PDFs:                            â”‚
â”‚  â”œâ”€ f1040-2024.pdf                    â”‚
â”‚  â”œâ”€ i1040-2024.pdf (instructions)     â”‚
â”‚  â”œâ”€ f1040sb-2024.pdf                  â”‚
â”‚  â””â”€ ...                               â”‚
â”‚                                        â”‚
â”‚  CLI-Style Functions:                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ open(form_name)            â”‚       â”‚
â”‚  â”‚ find(query_regex)          â”‚       â”‚
â”‚  â”‚ goto(page, line)           â”‚       â”‚
â”‚  â”‚ get_line_instructions()    â”‚       â”‚
â”‚  â”‚ worksheet(name)            â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                        â”‚
â”‚  Output: Grounded IRS Context         â”‚
â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. Deterministic Tools

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      DETERMINISTIC TOOLS               â”‚
â”‚         (NO LLM - 100% Accurate)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                        â”‚
â”‚  Tax Table (2024):                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ calculate_tax(income,    â”‚         â”‚
â”‚  â”‚               status)     â”‚         â”‚
â”‚  â”‚                           â”‚         â”‚
â”‚  â”‚ Uses: IRS Tax Brackets   â”‚         â”‚
â”‚  â”‚ Result: Exact tax amount â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                        â”‚
â”‚  Standard Deduction (2024):           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ get_standard_deduction(  â”‚         â”‚
â”‚  â”‚   status, age, blind)     â”‚         â”‚
â”‚  â”‚                           â”‚         â”‚
â”‚  â”‚ Single:       $14,600    â”‚         â”‚
â”‚  â”‚ MFJ:          $29,200    â”‚         â”‚
â”‚  â”‚ 65+ or Blind: +$1,550-   â”‚         â”‚
â”‚  â”‚               $1,950      â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                        â”‚
â”‚  Schedule SE Tax:                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ Calculate SE tax with:   â”‚         â”‚
â”‚  â”‚ â€¢ 92.35% rule            â”‚         â”‚
â”‚  â”‚ â€¢ SS wage base ($168.6k) â”‚         â”‚
â”‚  â”‚ â€¢ Medicare (2.9%)        â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. Type System

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         TYPE SYSTEM (Pydantic)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                        â”‚
â”‚  Input Types:                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ TaxInputs                  â”‚       â”‚
â”‚  â”‚ Form1040Inputs             â”‚       â”‚
â”‚  â”‚ ScheduleBInputs            â”‚       â”‚
â”‚  â”‚  ...                       â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                        â”‚
â”‚  Output Types:                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ Form1040Outputs            â”‚       â”‚
â”‚  â”‚   â”œâ”€ line_1z: float        â”‚       â”‚
â”‚  â”‚   â”œâ”€ line_11: float (AGI)  â”‚       â”‚
â”‚  â”‚   â”œâ”€ line_15: float        â”‚       â”‚
â”‚  â”‚   â””â”€ ...                   â”‚       â”‚
â”‚  â”‚                             â”‚       â”‚
â”‚  â”‚ ScheduleBOutputs           â”‚       â”‚
â”‚  â”‚ ScheduleCOutputs           â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                        â”‚
â”‚  Benefits:                            â”‚
â”‚  â€¢ Runtime validation                 â”‚
â”‚  â€¢ Auto JSON serialization            â”‚
â”‚  â€¢ IDE autocomplete                   â”‚
â”‚  â€¢ Type checking                      â”‚
â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow Example: Single W-2 Filer

```
Step 1: INPUT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
input.json:
{
  "filing_status": "single",
  "w2": [{"wages": 50000, "withholding": 5000}]
}
          â”‚
          â–¼

Step 2: PARSING
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TaxReturnProcessor.parse_inputs()
  â””â”€â–º TaxInputs (Pydantic model)
          â”‚
          â–¼

Step 3: FORM PROCESSING
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Form1040Agent.process()
  â”œâ”€â–º Line 1z: $50,000 (from W-2)
  â”œâ”€â–º Line 11: $50,000 (AGI)
  â”œâ”€â–º Line 12: $14,600 (std deduction)
  â”œâ”€â–º Line 15: $35,400 (taxable income)
  â”‚
  â”œâ”€â–º [DETERMINISTIC] Tax Table:
  â”‚   calculate_tax(35400, "single")
  â”‚   â””â”€â–º $4,016
  â”‚
  â”œâ”€â–º Line 16: $4,016
  â”œâ”€â–º Line 24: $4,016 (total tax)
  â”œâ”€â–º Line 33: $5,000 (withholding)
  â””â”€â–º Line 34: $984 (REFUND!)
          â”‚
          â–¼

Step 4: VERIFICATION
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ArithmeticVerifier.verify()
  â”œâ”€â–º Check Line 9 = sum of income
  â”œâ”€â–º Check Line 11 = Line 9 - Line 10
  â”œâ”€â–º Check Line 15 = Line 11 - Line 12
  â””â”€â–º âœ“ All calculations correct!
          â”‚
          â–¼

Step 5: OUTPUT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Form1040Outputs â†’ output.xml
  â””â”€â–º Verified, complete tax return
```

---

## Key Architectural Decisions

### 1. Hybrid Approach

| Component | Method | Reason |
|-----------|--------|--------|
| **Tax Calculations** | Deterministic | 100% accuracy, no hallucinations |
| **IRS Instructions** | PDF Grounding | Official source, reduces errors |
| **Complex Logic** | LLM | Handles natural language, edge cases |
| **Verification** | Rules + LLM | Multi-layered validation |

### 2. Dependency Management

```
Independent:     Schedule B, Schedule C
                      â”‚
                      â–¼
Depends on C:        Schedule SE
                      â”‚
                      â–¼
Depends on SE:       Schedule 1
                      â”‚
                      â–¼
Central:             Form 1040
                      â”‚
                      â–¼
Depends on 1040:     Schedule 8812
```

### 3. Error Handling

```
Graceful Degradation:
  PDF missing? â”€â”€â–º Warn, continue without grounding
  LLM error?   â”€â”€â–º Retry with backoff
  Parse error? â”€â”€â–º Clear error message + guidance
```

---

## Performance Profile

```
Operation                    Time          Accuracy
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Tax Table Lookup            <1ms          100%
Standard Deduction          <1ms          100%
Schedule SE Calculation     <1ms          100%
PDF Text Extraction         ~100ms        N/A
LLM Generation (per call)   ~2-5s         Varies
Arithmetic Verification     ~10ms         100% (on math)
Full Form 1040 (simple)     ~10-20s       Verified
```

---

## Extensibility Points

### Adding a New Form

1. Define types in `src/core/types.py`
2. Implement agent in `src/agents/<form>_agent.py`
3. Add to dependency graph in `main.py`
4. Add tests

### Adding a New Verifier

1. Create `src/verifiers/<name>_verifier.py`
2. Implement `verify_<form>()` method
3. Add to verification pipeline
4. Return `VerificationResult`

### Adding a New Tool

1. Create `src/tools/<name>.py`
2. Implement as pure function
3. Import in relevant agent
4. Add tests

---

**Built with â¤ï¸ following "Perfecting Tax Returns Like Code"**
